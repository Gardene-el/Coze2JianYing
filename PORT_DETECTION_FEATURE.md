# 端口检测功能说明

## 功能描述

为本地服务标签页添加了端口可用性检测功能，用户可以在启动服务前检查端口是否被占用。

## 新增功能

### 1. 检测端口按钮

在端口输入框旁边新增了"检测端口"按钮，用户可以点击该按钮手动检测端口是否可用。

**位置**: 端口配置区域
```
端口: [8000    ] [检测端口]
```

### 2. 端口可用性检测

点击"检测端口"按钮后，系统会检测指定端口是否空闲：
- ✅ **端口可用**: 显示信息对话框"端口 {port} 当前空闲，可以使用。"
- ❌ **端口被占用**: 显示警告对话框"端口 {port} 已被其他程序占用，请选择其他端口。"

### 3. 启动服务前自动检测

在点击"启动服务"按钮时，系统会自动检测端口是否可用：
- 如果端口被占用，会显示错误对话框并阻止服务启动
- 提示用户"端口 {port} 已被其他程序占用。\n\n请选择其他端口或停止占用该端口的程序。"

## 技术实现

### 新增方法

#### `_check_port_available()`
```python
def _check_port_available(self):
    """检测端口是否可用"""
    # 验证端口号有效性
    # 调用 _is_port_available() 检测
    # 显示检测结果
```

#### `_is_port_available(port: int) -> bool`
```python
def _is_port_available(self, port: int) -> bool:
    """检查端口是否可用
    
    Args:
        port: 要检查的端口号
        
    Returns:
        True 如果端口可用，False 如果端口被占用
    """
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            s.bind(("localhost", port))
            return True
    except OSError:
        return False
```

### 检测原理

使用 Python 标准库 `socket` 模块：
1. 创建一个 TCP socket
2. 尝试绑定到 `localhost:port`
3. 如果绑定成功，说明端口空闲（返回 True）
4. 如果绑定失败（抛出 OSError），说明端口被占用（返回 False）

### UI 更新

#### 按钮状态管理
- **服务未启动**: 检测端口按钮可用
- **服务运行中**: 检测端口按钮禁用（灰色）

#### 状态栏更新
检测端口后，状态栏会显示检测结果：
- "端口 {port} 可用"
- "端口 {port} 被占用"

## 使用场景

### 场景 1: 检查默认端口
1. 用户打开本地服务标签页（默认端口 8000）
2. 点击"检测端口"按钮
3. 查看端口是否可用

### 场景 2: 更换端口
1. 用户输入新的端口号（如 8001）
2. 点击"检测端口"按钮验证
3. 确认端口可用后点击"启动服务"

### 场景 3: 启动失败
1. 用户点击"启动服务"
2. 系统自动检测端口被占用
3. 显示错误提示，阻止启动
4. 用户更换端口或停止占用程序

## 错误处理

### 无效端口号
- 输入非数字: "无效的端口号: invalid literal for int()"
- 端口号超出范围: "无效的端口号: 端口必须在 1024-65535 之间"

### 端口被占用
- **手动检测**: 显示警告对话框，用户可继续尝试其他端口
- **启动服务**: 显示错误对话框，阻止服务启动

## UI 界面

### 更新前
```
┌─────────────────────────────────────┐
│ 端口: [8000    ]                    │
└─────────────────────────────────────┘
```

### 更新后
```
┌─────────────────────────────────────┐
│ 端口: [8000    ] [检测端口]         │
└─────────────────────────────────────┘
```

## 测试覆盖

### 单元测试 (`test_port_detection.py`)
✅ 端口可用性检测逻辑
✅ 代码结构验证

### 综合测试 (`test_local_service_logic.py`)
✅ socket 模块导入
✅ _is_port_available 方法存在
✅ check_port_btn 组件存在

### 集成测试 (`test_tabbed_gui.py`)
✅ check_port_btn 属性验证

## 日志记录

系统会记录以下日志：
- `端口 {port} 可用` - INFO 级别
- `端口 {port} 已被占用` - WARNING 级别
- `无法启动服务: 端口 {port} 已被占用` - WARNING 级别

## 未来改进建议

1. **端口扫描**: 自动扫描可用端口并推荐
2. **占用进程信息**: 显示占用端口的进程名称和 PID
3. **端口历史**: 记录最近使用的端口号
4. **快速切换**: 预设常用端口号快速选择

## 相关文件

- `src/gui/local_service_tab.py` - 主要实现
- `test_port_detection.py` - 端口检测测试
- `test_local_service_logic.py` - 综合逻辑测试
- `test_tabbed_gui.py` - GUI 集成测试

## 依赖

- Python 标准库 `socket` - 端口检测
- `tkinter` - GUI 组件

## 兼容性

- ✅ Windows
- ✅ macOS
- ✅ Linux

所有操作系统均支持 socket 端口绑定检测。
