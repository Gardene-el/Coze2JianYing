# GUI 与 API 服务集成指南

## 📋 概述

本指南说明如何在 GUI 应用中使用集成的 FastAPI 服务功能。

## ✅ 已完成的集成

### 1. 依赖项配置

`requirements.txt` 已包含所有必要的依赖：

```txt
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
pydantic>=2.0.0
```

### 2. GUI 集成

在 `app/gui/local_service_tab.py` 中已集成真实的 FastAPI 服务：

- ✅ 导入 `uvicorn` 模块
- ✅ 使用 `uvicorn.Server` 运行 FastAPI 应用
- ✅ 在后台线程中启动服务
- ✅ 正确处理服务停止逻辑
- ✅ 完善的错误处理和资源清理

## 🚀 使用方法

### 启动 GUI 应用

```powershell
# 方法1: 直接运行主程序
python app/main.py

# 方法2: 使用模块方式
python -m app.main
```

### 在 GUI 中使用 API 服务

1. **打开应用**：启动 GUI 应用
2. **切换到本地服务标签页**：点击 "本地服务" 标签
3. **配置端口**（可选）：
   - 默认端口：8000
   - 可以修改为其他可用端口
   - 点击 "检测端口" 按钮验证端口是否可用
4. **启动服务**：
   - 点击 "启动服务" 按钮
   - 等待服务启动（会显示在服务信息区域）
5. **访问 API**：
   - 服务地址：http://localhost:8000
   - API 文档：http://localhost:8000/docs
   - 所有示例接口都可以使用
6. **停止服务**：
   - 点击 "停止服务" 按钮
   - 服务会正常关闭

## 🔍 功能说明

### 服务管理功能

| 功能       | 说明                                         |
| ---------- | -------------------------------------------- |
| 端口配置   | 可自定义服务端口（1024-65535）               |
| 端口检测   | 检测端口是否被占用                           |
| 启动服务   | 在后台线程启动 FastAPI 服务                  |
| 停止服务   | 优雅关闭服务，释放端口                       |
| 状态指示器 | 实时显示服务运行状态（绿色=运行，红色=停止） |
| 服务信息   | 显示服务启动、停止等操作日志                 |

### 草稿文件夹功能

| 功能     | 说明                     |
| -------- | ------------------------ |
| 自动检测 | 自动检测剪映草稿文件夹   |
| 手动选择 | 手动选择草稿输出文件夹   |
| 路径显示 | 显示当前选择的文件夹路径 |

## 🧪 测试步骤

### 基础测试

1. **启动 GUI**：

   ```powershell
   python app/main.py
   ```

2. **切换到本地服务标签页**

3. **检测端口**：

   - 确保端口 8000 可用
   - 如果被占用，选择其他端口

4. **启动服务**：

   - 点击 "启动服务"
   - 观察服务信息区域的日志
   - 确认状态指示器变为绿色

5. **访问 API 文档**：

   - 在浏览器中打开：http://localhost:8000/docs
   - 应该能看到 Swagger UI 界面

6. **测试 API**：

   - 在 Swagger UI 中测试健康检查接口
   - 测试创建 Item 接口
   - 测试其他接口

7. **停止服务**：
   - 点击 "停止服务"
   - 确认服务正常停止
   - 状态指示器变为红色

### 高级测试

#### 测试端口冲突

1. 启动服务（端口 8000）
2. 尝试再次启动服务
3. 应该显示警告："服务已在运行中！"

#### 测试端口占用

1. 在命令行中启动一个服务占用端口 8000：
   ```powershell
   python -m http.server 8000
   ```
2. 在 GUI 中尝试启动服务（端口 8000）
3. 应该显示错误："端口 8000 已被其他程序占用"

#### 测试服务稳定性

1. 启动服务
2. 在浏览器中持续访问 API（可使用测试脚本）
3. 观察服务是否稳定运行
4. 停止服务，确认所有请求正常结束

#### 测试资源清理

1. 启动服务
2. 不点击停止按钮，直接关闭 GUI 窗口
3. 检查端口是否正确释放：
   ```powershell
   netstat -ano | findstr :8000
   ```
4. 应该没有端口占用记录

## 📝 技术实现细节

### 服务启动流程

```python
# 1. 用户点击启动按钮
# 2. 验证端口号有效性
# 3. 检查端口是否可用
# 4. 创建后台线程
# 5. 在线程中配置 uvicorn.Config
# 6. 创建 uvicorn.Server 实例
# 7. 运行服务器（阻塞直到停止）
# 8. 更新 UI 状态
```

### 服务停止流程

```python
# 1. 用户点击停止按钮
# 2. 设置停止标志
# 3. 设置 uvicorn_server.should_exit = True
# 4. 设置 uvicorn_server.force_exit = True
# 5. 等待服务线程结束（最多3秒）
# 6. 更新 UI 状态
# 7. 清理资源
```

### 关键代码片段

#### 启动服务

```python
def _run_service(self, port: int):
    config = uvicorn.Config(
        "app.api_main:app",
        host="127.0.0.1",
        port=port,
        log_level="info",
        access_log=False
    )
    self.uvicorn_server = uvicorn.Server(config)
    self.uvicorn_server.run()
```

#### 停止服务

```python
def _stop_service(self):
    self.service_running = False
    self.stop_event.set()

    if self.uvicorn_server:
        self.uvicorn_server.should_exit = True
        self.uvicorn_server.force_exit = True
```

## ⚠️ 注意事项

### 1. 线程安全

- UI 更新必须在主线程中进行
- 使用 `self.frame.after()` 从后台线程调度 UI 更新
- 使用 `threading.Event` 进行线程间通信

### 2. 端口管理

- 默认端口：8000
- 推荐端口范围：8000-8999
- 避免使用系统端口（< 1024）
- 避免使用常用服务端口（如 3000, 5000 等）

### 3. 资源清理

- 关闭应用时自动停止服务
- 使用 `cleanup()` 方法清理资源
- 设置服务线程为 daemon 线程作为后备

### 4. 错误处理

- 端口被占用时显示明确的错误信息
- 服务启动失败时恢复 UI 状态
- 捕获并记录所有异常

## 🐛 故障排查

### 问题：点击启动服务后没有反应

**解决方案**：

1. 检查控制台/日志是否有错误信息
2. 确认端口未被占用
3. 检查 FastAPI 应用是否正确导入

### 问题：服务无法停止

**解决方案**：

1. 等待 3 秒（线程自动超时）
2. 关闭并重新打开应用
3. 使用任务管理器强制结束进程

### 问题：端口一直显示被占用

**解决方案**：

```powershell
# 查找占用端口的进程
netstat -ano | findstr :8000

# 结束进程（替换 PID）
taskkill /F /PID <PID>
```

### 问题：API 文档无法访问

**解决方案**：

1. 确认服务状态指示器为绿色
2. 确认浏览器地址正确：http://localhost:8000/docs
3. 检查防火墙设置
4. 尝试使用 127.0.0.1 替代 localhost

## 📚 相关文档

- `API_PROJECT_SUMMARY.md` - API 项目总览
- `API_TEST_GUIDE.md` - API 测试指南
- `QUICK_START_API.md` - API 快速启动
- `LOCAL_SERVICE_TAB_IMPLEMENTATION_SUMMARY.md` - 本地服务标签页实现文档

## 🎯 下一步开发建议

### 功能增强

1. **日志查看器**：在 GUI 中实时显示 API 请求日志
2. **请求监控**：显示当前活跃的请求数量
3. **配置持久化**：保存用户的端口设置
4. **一键测试**：集成 API 测试按钮
5. **性能监控**：显示请求响应时间、CPU 使用率等

### 安全增强

1. **访问控制**：添加 API 密钥验证
2. **HTTPS 支持**：支持 SSL 证书配置
3. **跨域限制**：配置允许的来源域名

### 用户体验

1. **自动端口选择**：如果默认端口被占用，自动选择可用端口
2. **服务预热**：启动时显示加载进度
3. **快捷访问**：添加 "打开浏览器" 按钮
4. **状态通知**：系统托盘图标和通知

---

**集成完成！** 🎉

现在你可以在 GUI 应用中直接启动和管理 FastAPI 服务了。
