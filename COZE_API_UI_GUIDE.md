# Coze API 设置 UI 界面说明

## 整体布局

本地服务标签页现在包含三个主要区域：

### 1. 草稿文件夹设置
```
┌─────────────────────────────────────────────────────────────────────┐
│ 草稿文件夹设置                                                       │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ 剪映草稿文件夹: [未选择（将使用默认路径）] [选择...] [自动检测] │ │
│ └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. Coze API 配置 (新增)
```
┌─────────────────────────────────────────────────────────────────────┐
│ Coze API 配置                                                        │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ API Token: [********************************] [☐ 显示]          │ │
│ │                                                                 │ │
│ │ 服务地址:  [https://api.coze.cn            ▼]                  │ │
│ │                                                                 │ │
│ │ 状态: 未配置                                      [测试连接]    │ │
│ └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 3. FastAPI 服务管理
```
┌─────────────────────────────────────────────────────────────────────┐
│ FastAPI 服务管理                                                     │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ 端口: [8000]                                      [检测端口]    │ │
│ │                                                                 │ │
│ │ ○ 端口状态: 未检测                                              │ │
│ │                                                                 │ │
│ │ ● 服务状态: 未启动                                              │ │
│ │                                                                 │ │
│ │ [启动服务] [停止服务]                                           │ │
│ │                                                                 │ │
│ │ ┌─────────────────────────────────────────────────────────────┐ │ │
│ │ │ 服务实时日志                                                │ │ │
│ │ │                                                             │ │ │
│ │ │ [日志内容区域]                                              │ │ │
│ │ │                                                             │ │ │
│ │ └─────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## Coze API 配置区域详细说明

### 组件列表

1. **API Token 输入框**
   - 位置: 第一行
   - 标签: "API Token:"
   - 输入框: 宽度 50 字符，密码模式 (show="*")
   - 默认显示: `********************************`
   - 用途: 输入 Coze API Token

2. **显示/隐藏复选框**
   - 位置: API Token 输入框右侧
   - 文本: "显示"
   - 类型: Checkbutton
   - 功能:
     - 未选中: Token 显示为 `*` (默认)
     - 选中: Token 显示明文

3. **服务地址下拉框**
   - 位置: 第二行
   - 标签: "服务地址:"
   - 类型: Combobox (只读)
   - 选项:
     ```
     https://api.coze.cn      (国内版 - 默认)
     https://api.coze.com     (国际版)
     ```
   - 宽度: 30 字符

4. **状态标签**
   - 位置: 第三行左侧
   - 文本格式: "状态: [状态文本]"
   - 可能的状态:
     - `未配置` (灰色) - 初始状态
     - `测试连接中...` (黑色) - 正在测试
     - `已配置 ✓` (绿色) - 配置成功
     - `连接失败 ✗` (红色) - 配置失败

5. **测试连接按钮**
   - 位置: 第三行右侧
   - 文本: "测试连接"
   - 功能: 验证 API Token 和服务地址

## 使用场景示例

### 场景 1: 初始状态
```
API Token: [                                  ] [☐ 显示]
服务地址:  [https://api.coze.cn            ▼]
状态: 未配置                                      [测试连接]
```

### 场景 2: 输入 Token 后
```
API Token: [********************************] [☐ 显示]
服务地址:  [https://api.coze.cn            ▼]
状态: 未配置                                      [测试连接]
```

### 场景 3: 显示 Token
```
API Token: [pat_xxxxxxxxxxxxxxxxxxxxxxxxxx] [☑ 显示]
服务地址:  [https://api.coze.cn            ▼]
状态: 未配置                                      [测试连接]
```

### 场景 4: 测试连接中
```
API Token: [********************************] [☐ 显示]
服务地址:  [https://api.coze.cn            ▼]
状态: 测试连接中...                               [测试连接]
```

### 场景 5: 连接成功
```
API Token: [********************************] [☐ 显示]
服务地址:  [https://api.coze.cn            ▼]
状态: 已配置 ✓                                   [测试连接]
      ^^^^^^ (绿色)
```

### 场景 6: 连接失败
```
API Token: [********************************] [☐ 显示]
服务地址:  [https://api.coze.cn            ▼]
状态: 连接失败 ✗                                 [测试连接]
      ^^^^^^^^ (红色)
```

### 场景 7: 切换国际版
```
API Token: [********************************] [☐ 显示]
服务地址:  [https://api.coze.com           ▼]
状态: 未配置                                      [测试连接]
```

## 交互流程

### 完整配置流程
1. 用户打开"本地服务"标签页
2. 在 API Token 输入框中输入 Token
3. (可选) 勾选"显示"复选框查看输入的 Token
4. (可选) 选择服务地址 (默认为国内版)
5. 点击"测试连接"按钮
6. 系统验证配置:
   - 检查 Token 是否为空
   - 尝试创建 Coze 客户端
   - 更新状态标签
7. 显示结果:
   - 成功: 状态变为绿色"已配置 ✓"，弹出成功提示
   - 失败: 状态变为红色"连接失败 ✗"，弹出错误提示

### 错误处理

#### 未输入 Token
- 触发: 点击"测试连接"但 Token 为空
- 行为: 弹出警告对话框 "请先输入 API Token"

#### 连接失败
- 触发: Token 无效或网络问题
- 行为:
  - 状态标签变为红色 "连接失败 ✗"
  - 弹出错误对话框，包含:
    - 错误信息
    - 检查建议 (Token、网络、Base URL)

#### cozepy 未安装
- 触发: 缺少 cozepy 库
- 行为: 弹出错误对话框 "cozepy 库未安装。请运行: pip install cozepy"

## 安全特性

1. **密码模式**: Token 默认显示为星号
2. **可选可见**: 用户可选择性显示 Token
3. **内存存储**: 不保存到文件或环境变量
4. **会话级别**: 应用关闭后自动清除

## 技术实现

### 关键代码片段

#### 创建 Coze 客户端
```python
from cozepy import Coze, TokenAuth

coze_api_token = self.token_var.get().strip()
base_url = self.base_url_var.get()

coze = Coze(
    auth=TokenAuth(coze_api_token),
    base_url=base_url
)
```

#### 切换 Token 可见性
```python
def _toggle_token_visibility(self):
    if self.show_token_var.get():
        self.token_entry.config(show="")  # 显示明文
    else:
        self.token_entry.config(show="*")  # 显示星号
```

#### 测试连接
```python
def _test_coze_connection(self):
    # 验证输入
    # 创建客户端
    # 更新状态
    # 显示结果
```

## 与其他组件的集成

### 获取 Coze 客户端
其他模块可以通过以下方式获取配置好的客户端:

```python
# 在 local_service_tab 实例中
coze_client = local_service_tab._get_coze_client()

if coze_client:
    # 使用 Coze API
    # 例如: coze_client.some_api_call()
    pass
else:
    # 处理未配置的情况
    logger.warning("Coze API 未配置")
```

## 未来扩展建议

1. **Token 验证**: 在输入时实时验证 Token 格式
2. **保存配置**: 可选的配置保存功能 (加密存储)
3. **多账号支持**: 支持切换多个 Coze 账号
4. **API 限额显示**: 显示 API 使用配额和限制
5. **快速测试**: 添加快速 API 测试功能

## 相关文档

- 实现文档: `COZE_API_SETTINGS_IMPLEMENTATION.md`
- 主代码: `app/gui/local_service_tab.py`
- 单元测试: `test_coze_api_settings.py`
- GUI 测试: `test_coze_gui.py`
