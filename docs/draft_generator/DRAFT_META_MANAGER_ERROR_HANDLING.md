# draft_meta_manager 错误处理指南

## 概述

`draft_meta_manager` 模块负责扫描剪映草稿文件夹并生成 `root_meta_info.json` 元信息文件。在扫描过程中，可能会遇到损坏或格式错误的草稿文件。本文档说明这些错误的原因、影响和解决方法。

## 常见错误类型

### 1. 空文件错误

**错误消息示例：**
```
草稿 265646ca-0818-4dfc-9a78-f281845f0cfd(15) 的 draft_meta_info.json 文件为空或仅包含空白字符。
这可能是因为文件损坏、被意外清空，或者该草稿未被剪映正确初始化。
建议：1) 在剪映中重新打开并保存该草稿  2) 或删除该草稿文件夹
```

**原因：**
- 文件为空（0 字节）
- 文件仅包含空白字符（空格、制表符、换行符等）
- 剪映在保存草稿时被意外中断
- 磁盘空间不足导致写入失败

**影响：**
- 该草稿无法被识别和导入
- 其他有效草稿不受影响
- 草稿扫描继续进行

**解决方法：**
1. **推荐方式**：在剪映中打开该草稿，然后重新保存
2. **替代方式**：如果草稿无法打开或不再需要，删除该草稿文件夹

### 2. 格式错误/多余数据

**错误消息示例：**
```
草稿 9F776C47-1C7C-44ca-82D1-882A267B9AE4 的 draft_meta_info.json 格式不正确。
文件可能包含多余数据、损坏，或由不兼容的剪映版本创建。
建议：1) 在剪映中重新打开并保存该草稿  2) 或删除该草稿文件夹
```

**原因：**
- 文件包含多个 JSON 对象（例如：`{}{}`）
- JSON 格式不正确（缺少引号、逗号等）
- 文件部分损坏（磁盘错误、突然断电等）
- 使用不兼容的剪映版本创建
- 手动编辑导致格式错误

**影响：**
- 该草稿无法被识别和导入
- 其他有效草稿不受影响
- 草稿扫描继续进行

**解决方法：**
1. **推荐方式**：在剪映中打开该草稿，然后重新保存
2. **替代方式**：如果草稿无法打开或不再需要，删除该草稿文件夹
3. **高级方式**：如果了解 JSON 格式，可以手动修复文件

## 错误处理机制

### 扫描行为

当 `draft_meta_manager` 扫描草稿文件夹时：

1. **识别草稿**：检查文件夹中是否存在 `draft_content.json` 和 `draft_meta_info.json`
2. **验证文件**：
   - 检查文件是否存在
   - 检查文件大小
   - 读取文件内容
   - 验证 JSON 格式
3. **错误处理**：
   - 记录详细的错误信息（包括文件大小、内容预览等）
   - 提供用户友好的错误消息
   - 给出可行的解决建议
   - 继续扫描其他草稿（不中断整个过程）
4. **生成报告**：
   - 统计有效草稿数量
   - 列出所有跳过的草稿
   - 提供恢复提示

### 日志输出示例

```
开始扫描草稿文件夹: C:\Users\user\AppData\Local\JianyingPro\User Data\Projects\com.lveditor.draft
草稿 corrupted_draft_1 的 draft_meta_info.json 文件为空或仅包含空白字符。...
  ✅ 找到草稿: valid_draft_1
草稿 corrupted_draft_2 的 draft_meta_info.json 格式不正确。...
  ✅ 找到草稿: valid_draft_2
  ✅ 找到草稿: valid_draft_3
扫描完成，共找到 3 个有效草稿
⚠️  以下 2 个草稿由于文件损坏或格式错误被跳过: corrupted_draft_1, corrupted_draft_2
💡 提示：这些草稿可能是剪映未正确保存的草稿。建议在剪映中重新打开并保存它们，或者删除这些文件夹。
```

## 预防措施

### 避免草稿文件损坏

1. **正常退出**：始终通过正常方式关闭剪映，避免强制结束进程
2. **定期保存**：在编辑过程中定期保存草稿
3. **磁盘空间**：确保磁盘有足够的可用空间
4. **稳定电源**：使用 UPS 或确保电源稳定，避免突然断电
5. **文件备份**：定期备份重要的草稿项目

### 草稿文件夹管理

1. **不要手动编辑**：不要直接编辑 JSON 文件，除非你了解其结构
2. **不要移动文件**：不要在剪映运行时移动或重命名草稿文件夹
3. **定期清理**：删除不再需要的草稿以保持文件夹整洁

## 技术细节

### JSON 文件结构

每个草稿文件夹包含两个关键的 JSON 文件：

1. **draft_content.json**：草稿内容，包含轨道、片段、素材等信息
2. **draft_meta_info.json**：草稿元数据，包含名称、ID、创建时间等信息

### 错误检测机制

```python
# 1. 文件存在性检查
if not os.path.exists(file_path):
    raise FileNotFoundError(...)

# 2. 文件大小检查
file_size = os.path.getsize(file_path)

# 3. 内容读取
with open(file_path, 'r', encoding='utf-8') as f:
    content = f.read()

# 4. 空白检查
if not content or not content.strip():
    raise ValueError("文件为空或仅包含空白字符")

# 5. JSON 解析
try:
    data = json.loads(content)
except json.JSONDecodeError as e:
    # 提供详细的错误信息和内容预览
    ...
```

### 诊断信息

在调试模式下，错误消息会包含：
- 文件完整路径
- 文件大小（字节）
- 文件内容预览（前 100 个字符）
- JSON 解析错误的具体位置

## 常见问题解答

### Q: 为什么会出现空文件？

A: 主要原因包括：
- 剪映在保存时崩溃或被强制关闭
- 磁盘空间不足
- 文件系统错误
- 杀毒软件干扰

### Q: 损坏的草稿可以恢复吗？

A: 取决于损坏程度：
- **轻微损坏**：在剪映中重新打开并保存通常可以修复
- **严重损坏**：可能无法恢复，建议删除
- **部分恢复**：如果熟悉 JSON 格式，可以尝试手动修复

### Q: 扫描失败会影响草稿生成吗？

A: 不会。错误处理是隔离的：
- 每个草稿独立处理
- 一个草稿的错误不影响其他草稿
- 扫描会继续进行，只跳过有问题的草稿
- 最终生成的 `root_meta_info.json` 只包含有效草稿

### Q: 如何手动修复 JSON 文件？

A: 如果你了解 JSON 格式：
1. 用文本编辑器打开文件（推荐 VS Code、Notepad++ 等）
2. 检查 JSON 语法：
   - 所有字符串用双引号
   - 键值对用冒号分隔
   - 元素用逗号分隔（最后一个元素后不要逗号）
   - 正确使用大括号和方括号
3. 使用在线 JSON 验证器验证修复后的内容
4. 保存文件并重新扫描

### Q: 错误消息在哪里查看？

A: 错误消息会输出到：
1. **控制台**：如果从命令行运行
2. **日志文件**：应用的日志文件中
3. **GUI 日志窗口**：如果使用图形界面

## 相关资源

- [draft_meta_manager.py 源代码](/src/utils/draft_meta_manager.py)
- [错误处理测试](/test_draft_meta_manager_errors.py)
- [草稿生成器架构文档](/docs/draft_generator/ARCHITECTURE_AND_WORKFLOW.md)
