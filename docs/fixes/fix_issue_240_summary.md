# Fix for Issue #240: Empty CustomNamespace Object Handling

## Problem Description

When executing scripts generated by Coze handlers, the following error occurred:

```
2 validation errors for TimeRange
start
  Field required [type=missing, input_value={}, input_type=dict]
duration
  Field required [type=missing, input_value={}, input_type=dict]
```

### Root Cause

The issue was in the handler generator code (`scripts/handler_generator/e_api_call_code_generator.py`). When Coze passed an empty `CustomNamespace()` object for optional complex type parameters (like `TimeRange`, `ClipSettings`), the generated code would check:

```python
if CustomNamespace() is not None:
    req_params['source_timerange'] = TimeRange()
```

This condition is **always True** because even an empty `CustomNamespace()` object is not `None`. This caused the code to try creating objects with missing required parameters, leading to Pydantic validation errors.

### Example from Error Log

```python
# Generated code (BEFORE fix)
if CustomNamespace() is not None:
    req_params_591ab9ac['source_timerange'] = TimeRange()  # ❌ Missing required params!
```

## Solution Implemented

### 1. Added `_is_meaningful_object()` Helper Function

Added a new helper function in `d_handler_function_generator.py` that properly checks if a CustomNamespace object contains meaningful data:

```python
def _is_meaningful_object(obj) -> bool:
    """
    检查对象是否包含有意义的数据
    
    用于区分空的 CustomNamespace() 对象和包含有效数据的对象
    避免将空对象视为有效值，导致 Pydantic 验证失败
    """
    # None 值不是有意义的对象
    if obj is None:
        return False
    
    # 检查是否有 __dict__ 属性（CustomNamespace, SimpleNamespace 等）
    if hasattr(obj, '__dict__'):
        obj_dict = obj.__dict__
        # 空字典意味着空对象
        if not obj_dict:
            return False
        # 检查是否所有值都是 None（也视为空对象）
        if all(v is None for v in obj_dict.values()):
            return False
        # 至少有一个非 None 值，视为有意义的对象
        return True
    
    # 对于基本类型（字符串、数字、布尔值等），非 None 即为有意义
    return True
```

### 2. Updated Condition Generation Logic

Modified `e_api_call_code_generator.py` to use different checks for complex types vs simple types:

```python
# In _format_condition_value method
if self._is_complex_type(field_type):
    # 复杂类型：使用 _is_meaningful_object 辅助函数
    return "{_is_meaningful_object(" + access_expr + ")}"
else:
    # 简单类型：直接使用插值表达式
    return "{" + access_expr + "}"

# In generate_api_call_code method
if self._is_complex_type(field_type):
    # 复杂类型：使用 _is_meaningful_object() 直接返回 bool
    request_construction += "if " + condition_value + ":\n"
else:
    # 简单类型：需要 'is not None' 检查
    request_construction += "if " + condition_value + " is not None:\n"
```

### 3. Generated Code Comparison

#### Before Fix:
```python
# ❌ 问题：空对象被错误地视为有效值
if CustomNamespace() is not None:  # Always True!
    req_params['source_timerange'] = TimeRange()  # Validation error!
```

#### After Fix:
```python
# ✅ 正确：空对象被正确过滤
if _is_meaningful_object(args.input.source_timerange):  # Returns False for empty objects
    req_params['source_timerange'] = TimeRange(start=0, duration=5000000)
# Empty CustomNamespace is correctly skipped, no validation error!
```

## Test Results

### New Test: `test_empty_customnamespace_fix.py`

Created comprehensive test covering:
1. **`_is_meaningful_object` function logic** - Tests various input scenarios
2. **Generated code with empty objects** - Verifies correct filtering
3. **Coze runtime simulation** - Tests real-world scenarios

Result: **3/3 tests passed** ✅

### Updated Test: `test_optional_params.py`

Updated to accept both old and new condition formats:
```python
"可选字段有 None 检查或 _is_meaningful_object 检查",
"if {args.input.source_timerange} is not None:" in api_call_code
or "if {_is_meaningful_object(args.input.source_timerange)}:" in api_call_code,
```

Result: **4/4 tests passed** ✅

### Existing Test: `test_type_constructor.py`

No changes needed, all tests still pass.

Result: **4/4 tests passed** ✅

## Files Changed

### Core Changes
1. **`scripts/handler_generator/d_handler_function_generator.py`**
   - Added `_is_meaningful_object()` helper function (33 lines)

2. **`scripts/handler_generator/e_api_call_code_generator.py`**
   - Updated `_format_condition_value()` method
   - Updated condition generation in `generate_api_call_code()`

### Regenerated Handlers
All 28 handler files in `coze_plugin/raw_tools/` were regenerated with the fix:
- `create_audio_segment/handler.py`
- `create_video_segment/handler.py`
- `create_text_segment/handler.py`
- `create_sticker_segment/handler.py`
- And 24 others...

### Tests
1. **New**: `scripts/test_empty_customnamespace_fix.py` (313 lines)
2. **Updated**: `scripts/test_optional_params.py` (3 lines changed)
3. **New**: `scripts/test_generated_script_example.py` (demonstration)

## Impact Analysis

### What Changed
- Complex type optional parameters (TimeRange, ClipSettings, CropSettings, TextStyle) now properly filter empty objects
- Simple type optional parameters (str, int, float, bool) continue to use `is not None` check
- All existing functionality preserved

### Backward Compatibility
✅ **Fully backward compatible** - All existing tests pass without modification (except one test updated to accept both formats)

### Performance Impact
Minimal - Only adds one function call for each optional complex type parameter

## Verification Steps

To verify the fix works:

1. **Run the tests**:
   ```bash
   python scripts/test_empty_customnamespace_fix.py
   python scripts/test_type_constructor.py
   python scripts/test_optional_params.py
   ```

2. **Check generated code**:
   ```bash
   # Look at any handler file
   cat coze_plugin/raw_tools/create_audio_segment/handler.py
   # Should see: if {_is_meaningful_object(args.input.source_timerange)}:
   ```

3. **Run demonstration**:
   ```bash
   python scripts/test_generated_script_example.py
   ```

## Examples

### Audio Segment with Empty source_timerange

**Input from Coze**:
```python
material_url = "https://example.com/audio.mp3"
target_timerange = CustomNamespace(start=0, duration=5000000)
source_timerange = CustomNamespace()  # Empty!
speed = 1
volume = 0.6
change_pitch = True
```

**Generated Code (After Fix)**:
```python
req_params['material_url'] = "https://example.com/audio.mp3"
req_params['target_timerange'] = TimeRange(start=0, duration=5000000)
# source_timerange is skipped - empty object detected!
req_params['speed'] = 1
req_params['volume'] = 0.6
req_params['change_pitch'] = True
```

**Result**: ✅ No validation error, code executes successfully

### Video Segment with Multiple Empty Objects

**Input from Coze**:
```python
material_url = "https://example.com/video.mp4"
target_timerange = CustomNamespace(duration=4200000, start=0)
source_timerange = CustomNamespace()  # Empty
clip_settings = CustomNamespace()    # Empty
crop_settings = CustomNamespace()    # Empty
```

**Generated Code (After Fix)**:
```python
req_params['material_url'] = "https://example.com/video.mp4"
req_params['target_timerange'] = TimeRange(duration=4200000, start=0)
# All empty objects are correctly filtered out!
```

**Result**: ✅ No validation error, minimal code generated

## Conclusion

The fix successfully addresses Issue #240 by:
1. Properly distinguishing empty CustomNamespace objects from meaningful ones
2. Preventing Pydantic validation errors
3. Maintaining full backward compatibility
4. Providing comprehensive test coverage

All tests pass and the generated code now correctly handles empty CustomNamespace objects passed from Coze.
