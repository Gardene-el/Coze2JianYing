# 本地服务标签页 UI 设计文档

## 概述

本文档描述了新增的"本地服务"标签页的用户界面设计和功能。

## 标签页名称变更

- **旧名称**: "草稿生成"
- **新名称**: "手动草稿生成"

## 新标签页: 本地服务

### 整体布局

标签页分为三个主要区域：

```
┌─────────────────────────────────────────────────────────────┐
│ 草稿文件夹设置                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 剪映草稿文件夹: [未选择（将使用默认路径）] [选择...] [自动检测] │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ FastAPI 服务管理                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 端口: [8000]                                             │ │
│ │                                                          │ │
│ │ ● 服务状态: 未启动                                        │ │
│ │                                                          │ │
│ │ [启动服务] [停止服务]                                     │ │
│ │                                                          │ │
│ │ ┌───────────────────────────────────────────────────┐   │ │
│ │ │ 服务信息                                           │   │ │
│ │ │ ┌───────────────────────────────────────────────┐ │   │ │
│ │ │ │ [HH:MM:SS] 正在启动服务...                    │ │   │ │
│ │ │ │ [HH:MM:SS] 服务已启动                         │ │   │ │
│ │ │ │ [HH:MM:SS] 访问地址: http://localhost:8000   │ │   │ │
│ │ │ │ [HH:MM:SS] API文档: http://localhost:8000/docs│ │   │ │
│ │ │ └───────────────────────────────────────────────┘ │   │ │
│ │ └───────────────────────────────────────────────────┘   │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 状态栏: 就绪                                                 │
└─────────────────────────────────────────────────────────────┘
```

## 功能组件详解

### 1. 草稿文件夹设置区域

这个区域与"手动草稿生成"标签页的文件夹选择功能完全相同。

**组件**:
- **文件夹路径显示**: 只读文本框，显示当前选择的剪映草稿文件夹路径
- **选择文件夹按钮**: 打开文件夹选择对话框，允许用户手动选择剪映草稿文件夹
- **自动检测按钮**: 自动检测系统中剪映专业版的默认草稿文件夹位置

**默认状态**: 显示"未选择（将使用默认路径）"

### 2. FastAPI 服务管理区域

这是本标签页的核心功能区域，用于管理FastAPI服务的生命周期。

#### 2.1 服务配置

**端口设置**:
- 默认端口: 8000
- 可编辑范围: 1024-65535
- 服务运行时端口输入框被禁用

#### 2.2 服务状态显示

**状态指示器**:
- 🔴 红色圆点: 服务未启动
- 🟢 绿色圆点: 服务运行中

**状态文本**:
- "服务状态: 未启动"
- "服务状态: 运行中 (端口 8000)"
- "服务状态: 错误"

#### 2.3 服务控制按钮

**启动服务按钮**:
- 初始状态: 可用
- 点击后: 禁用，"停止服务"按钮变为可用
- 功能: 在后台线程中启动FastAPI服务

**停止服务按钮**:
- 初始状态: 禁用
- 服务运行时: 可用
- 功能: 停止正在运行的FastAPI服务

#### 2.4 服务信息显示

带时间戳的日志文本框，显示服务运行时的各种信息：
- 服务启动/停止消息
- 服务访问地址
- API文档地址
- 错误信息（如果有）

**示例日志**:
```
[14:30:15] 正在启动服务...
[14:30:16] 服务已启动
[14:30:16] 访问地址: http://localhost:8000
[14:30:16] API文档: http://localhost:8000/docs
```

### 3. 底部状态栏

显示当前操作状态：
- "就绪" - 默认状态
- "输出文件夹: [路径]" - 选择文件夹后
- "已检测到: [路径]" - 自动检测成功后
- "服务运行中 - http://localhost:[端口]" - 服务运行时
- "服务错误" - 服务出错时

## 标签页顺序

应用程序中的标签页按以下顺序显示：
1. **手动草稿生成** (原"草稿生成")
2. **本地服务** (新增)
3. **示例标签页**

## 技术实现要点

### FastAPI 服务占位符

当前实现使用了一个占位符FastAPI服务：

```python
def _run_service(self, port: int):
    """运行FastAPI服务（后台线程）"""
    try:
        # 这是一个占位符实现
        # 实际的FastAPI服务将在后续实现
        self.logger.info("FastAPI服务线程已启动（占位符实现）")
        
        # 模拟服务运行
        while self.service_running:
            time.sleep(1)
        
        self.logger.info("FastAPI服务线程已停止")
    except Exception as e:
        self.logger.error(f"FastAPI服务出错: {e}", exc_info=True)
        self.frame.after(0, self._on_service_error, e)
```

### 线程管理

- 服务在单独的守护线程中运行
- 使用 `self.service_running` 标志控制服务生命周期
- 线程安全的GUI更新通过 `frame.after()` 实现

### 资源清理

在 `cleanup()` 方法中：
1. 停止服务（设置 `service_running = False`）
2. 等待线程终止（最多2秒）
3. 清理其他资源

## 用户使用流程

### 启动服务的典型流程

1. 用户打开"本地服务"标签页
2. （可选）配置草稿文件夹路径
3. （可选）修改服务端口（默认8000）
4. 点击"启动服务"按钮
5. 观察状态指示器变为绿色
6. 在服务信息区域查看服务地址
7. 通过浏览器访问服务

### 停止服务的流程

1. 点击"停止服务"按钮
2. 观察状态指示器变为红色
3. 查看服务信息确认服务已停止

## 错误处理

### 端口冲突

如果指定的端口已被占用（在实际FastAPI实现后）：
- 显示错误消息
- 自动停止服务
- 允许用户更改端口重试

### 无效端口

如果用户输入的端口号不在有效范围（1024-65535）：
- 弹出错误对话框
- 阻止服务启动
- 提示用户输入有效端口号

## 未来扩展计划

标签页设计预留了以下扩展空间：

1. **实际FastAPI服务实现**: 替换当前的占位符
2. **服务配置选项**: 添加更多配置项（如CORS设置、日志级别等）
3. **自动重启**: 服务崩溃后自动重启功能
4. **服务日志**: 更详细的服务运行日志
5. **API端点管理**: 显示和管理可用的API端点

## 可访问性

- 所有按钮都有清晰的标签
- 状态变化有视觉反馈（颜色、文本）
- 支持键盘导航
- 错误消息清晰易懂

## 测试覆盖

已实现的测试：
- ✅ 代码结构测试
- ✅ 继承关系测试
- ✅ 方法完整性测试
- ✅ UI组件存在性测试
- ✅ 服务管理逻辑测试
- ✅ 文件夹检测逻辑测试

## 总结

本地服务标签页成功整合了：
1. 与手动草稿生成相同的文件夹管理功能
2. 完整的FastAPI服务生命周期管理
3. 清晰的状态反馈机制
4. 为未来扩展预留的架构设计

这个实现为后续添加实际的API服务功能提供了坚实的基础。
