name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: windows-latest

    # åœ¨ job çº§åˆ«è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½ä½¿ç”¨ UTF-8
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      # å¼ºåˆ¶ Python ä½¿ç”¨ UTF-8
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿åˆ†æ commits
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Set up UTF-8 encoding
        run: |
          # è®¾ç½®æ§åˆ¶å°ä»£ç é¡µä¸º UTF-8
          chcp 65001

          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæŒä¹…åŒ–åˆ°åç»­æ­¥éª¤ï¼‰
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV

          # è®¾ç½® Git ä½¿ç”¨ UTF-8
          git config --global core.quotepath false
          git config --global i18n.commitencoding utf-8
          git config --global i18n.logoutputencoding utf-8
          git config --global core.pager "cat"

          # éªŒè¯è®¾ç½®
          Write-Host "å½“å‰ä»£ç é¡µ: $(chcp)"
          Write-Host "PYTHONIOENCODING: $env:PYTHONIOENCODING"
          Write-Host "PYTHONUTF8: $env:PYTHONUTF8"
          Write-Host "Git encoding config:"
          git config --get i18n.commitencoding
          git config --get i18n.logoutputencoding

      - name: Install dependencies
        run: |
          chcp 65001
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-semantic-release

      - name: Configure Git
        run: |
          chcp 65001
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ç¡®ä¿ UTF-8 ç¼–ç 
          git config core.quotepath false
          git config i18n.commitencoding utf-8
          git config i18n.logoutputencoding utf-8

      - name: Debug Git Log Encoding
        run: |
          chcp 65001
          Write-Host "=== æµ‹è¯• Git Log ç¼–ç  ==="
          git log --oneline -5
          Write-Host "=== Python ç¼–ç æµ‹è¯• ==="
          python -c "import sys; print(f'stdout encoding: {sys.stdout.encoding}'); print(f'default encoding: {sys.getdefaultencoding()}')"

      - name: Check for version bump
        id: check_version
        run: |
          chcp 65001

          # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬
          Write-Host "=== è¿è¡Œ semantic-release version --print ==="
          $output = ""
          $exitCode = 0

          try {
            $output = semantic-release version --print --no-commit --no-tag --no-push 2>&1
            $exitCode = $LASTEXITCODE
          } catch {
            $output = $_.Exception.Message
            $exitCode = 1
          }

          Write-Host "Exit code: $exitCode"
          Write-Host "Output:"
          Write-Host $output

          if ($output -match "No release will be made") {
            Write-Host "::notice::æ²¡æœ‰éœ€è¦å‘å¸ƒçš„æ›´æ–°ï¼ˆæ— ç¬¦åˆæ¡ä»¶çš„ commitï¼‰"
            echo "should_release=false" >> $env:GITHUB_OUTPUT
          } elseif ($exitCode -eq 0) {
            Write-Host "::notice::æ£€æµ‹åˆ°éœ€è¦å‘å¸ƒçš„æ›´æ–°"
            echo "should_release=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "::error::semantic-release æ‰§è¡Œå¤±è´¥"
            exit 1
          }

      - name: Build executable
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          chcp 65001
          python build.py

      - name: Semantic Release
        if: steps.check_version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chcp 65001

          Write-Host "=== æ‰§è¡Œ semantic-release version ==="
          semantic-release version

          Write-Host "=== æ‰§è¡Œ semantic-release publish ==="
          semantic-release publish

      - name: Get new version
        if: steps.check_version.outputs.should_release == 'true'
        id: version
        run: |
          chcp 65001

          # ä» Git tags è·å–æœ€æ–°ç‰ˆæœ¬
          $latestTag = git describe --tags --abbrev=0
          Write-Host "æœ€æ–°æ ‡ç­¾: $latestTag"

          echo "version=$latestTag" >> $env:GITHUB_OUTPUT

      - name: Upload release asset
        if: steps.check_version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chcp 65001

          $version = "${{ steps.version.outputs.version }}"
          Write-Host "å‡†å¤‡ä¸Šä¼ åˆ°ç‰ˆæœ¬: $version"

          if (Test-Path dist/CozeJianYingDraftGenerator.exe) {
            gh release upload $version dist/CozeJianYingDraftGenerator.exe --clobber
            Write-Host "âœ… å·²ä¸Šä¼  CozeJianYingDraftGenerator.exe åˆ° Release $version"
          } else {
            Write-Host "âŒ æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          }

      - name: Summary
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          chcp 65001
          Write-Host "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
          Write-Host "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          Write-Host "æŸ¥çœ‹ Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
