name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: windows-latest

    # åœ¨ job çº§åˆ«è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼Œç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½ä½¿ç”¨ UTF-8
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      # å¼ºåˆ¶ Python ä½¿ç”¨ UTF-8
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿åˆ†æž commits
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Set up UTF-8 encoding
        run: |
          # è®¾ç½®æŽ§åˆ¶å°ä»£ç é¡µä¸º UTF-8
          chcp 65001

          # è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆæŒä¹…åŒ–åˆ°åŽç»­æ­¥éª¤ï¼‰
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          echo "PYTHONUTF8=1" >> $env:GITHUB_ENV

          # è®¾ç½® Git ä½¿ç”¨ UTF-8
          git config --global core.quotepath false
          git config --global i18n.commitencoding utf-8
          git config --global i18n.logoutputencoding utf-8
          git config --global core.pager "cat"

          # éªŒè¯è®¾ç½®
          Write-Host "å½“å‰ä»£ç é¡µ: $(chcp)"
          Write-Host "PYTHONIOENCODING: $env:PYTHONIOENCODING"
          Write-Host "PYTHONUTF8: $env:PYTHONUTF8"
          Write-Host "Git encoding config:"
          git config --get i18n.commitencoding
          git config --get i18n.logoutputencoding

      - name: Install dependencies
        run: |
          chcp 65001
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-semantic-release

      - name: Configure Git
        run: |
          chcp 65001
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ç¡®ä¿ UTF-8 ç¼–ç 
          git config core.quotepath false
          git config i18n.commitencoding utf-8
          git config i18n.logoutputencoding utf-8

      - name: Debug Git Log Encoding
        run: |
          chcp 65001
          Write-Host "=== æµ‹è¯• Git Log ç¼–ç  ==="
          git log --oneline -5
          Write-Host "=== Python ç¼–ç æµ‹è¯• ==="
          python -c "import sys; print(f'stdout encoding: {sys.stdout.encoding}'); print(f'default encoding: {sys.getdefaultencoding()}')"

      - name: Check for version bump
        id: check_version
        run: |
          chcp 65001

          # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬
          Write-Host "=== è¿è¡Œ semantic-release version --print ==="
          $output = ""
          $exitCode = 0

          try {
            $output = semantic-release version --print --no-commit --no-tag --no-push 2>&1
            $exitCode = $LASTEXITCODE
          } catch {
            $output = $_.Exception.Message
            $exitCode = 1
          }

          Write-Host "Exit code: $exitCode"
          Write-Host "Output:"
          Write-Host $output

          if ($output -match "No release will be made") {
            Write-Host "::notice::æ²¡æœ‰éœ€è¦å‘å¸ƒçš„æ›´æ–°ï¼ˆæ— ç¬¦åˆæ¡ä»¶çš„ commitï¼‰"
            echo "should_release=false" >> $env:GITHUB_OUTPUT
          } elseif ($exitCode -eq 0) {
            Write-Host "::notice::æ£€æµ‹åˆ°éœ€è¦å‘å¸ƒçš„æ›´æ–°"
            echo "should_release=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "::error::semantic-release æ‰§è¡Œå¤±è´¥"
            exit 1
          }

      - name: Semantic Release (version + build + publish)
        if: steps.check_version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chcp 65001

          Write-Host "=== æ‰§è¡Œ semantic-release version ==="
          Write-Host "æ­¤æ­¥éª¤ä¼šè‡ªåŠ¨ï¼š"
          Write-Host "  1. æ›´æ–°ç‰ˆæœ¬å·"
          Write-Host "  2. æ‰§è¡Œ build_command (python build.py)"
          Write-Host "  3. åˆ›å»º commit å’Œ tag"
          semantic-release version

          Write-Host ""
          Write-Host "=== æ‰“åŒ… coze_plugin å†…å®¹ ==="
          # åˆ›å»º coze_plugin.zip åŒ…å«æ‰€æœ‰å·¥å…·
          if (Test-Path coze_plugin) {
            # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
            if (-not (Test-Path dist)) {
              New-Item -ItemType Directory -Path dist
            }
            
            # ä½¿ç”¨ PowerShell åŽ‹ç¼©
            Compress-Archive -Path coze_plugin\* -DestinationPath dist\coze_plugin.zip -Force
            
            # éªŒè¯æ–‡ä»¶
            if (Test-Path dist/coze_plugin.zip) {
              $zipSize = (Get-Item dist/coze_plugin.zip).Length / 1KB
              Write-Host "âœ… coze_plugin.zip å·²åˆ›å»º: $([math]::Round($zipSize, 2)) KB"
            } else {
              Write-Host "âš ï¸ è­¦å‘Š: coze_plugin.zip åˆ›å»ºå¤±è´¥"
            }
          } else {
            Write-Host "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° coze_plugin ç›®å½•"
          }

          Write-Host ""
          Write-Host "=== æ‰§è¡Œ semantic-release publish ==="
          Write-Host "æ­¤æ­¥éª¤ä¼šè‡ªåŠ¨ï¼š"
          Write-Host "  1. åˆ›å»º GitHub Release"
          Write-Host "  2. ä¸Šä¼  dist/*.exe å’Œ dist/*.zip åˆ° Release"
          semantic-release publish

      - name: Get new version and summary
        if: steps.check_version.outputs.should_release == 'true'
        id: version
        run: |
          chcp 65001

          # ä»Ž Git tags èŽ·å–æœ€æ–°ç‰ˆæœ¬
          $latestTag = git describe --tags --abbrev=0
          Write-Host "ðŸŽ‰ å‘å¸ƒå®Œæˆï¼"
          Write-Host "æ–°ç‰ˆæœ¬: $latestTag"
          Write-Host "æŸ¥çœ‹ Release: https://github.com/${{ github.repository }}/releases/tag/$latestTag"

          # éªŒè¯ exe æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (Test-Path dist/CozeJianYingDraftGenerator.exe) {
            $fileSize = (Get-Item dist/CozeJianYingDraftGenerator.exe).Length / 1MB
            Write-Host "âœ… å¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ: $([math]::Round($fileSize, 2)) MB"
          } else {
            Write-Host "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          }

          # éªŒè¯ coze_plugin.zip æ˜¯å¦å­˜åœ¨
          if (Test-Path dist/coze_plugin.zip) {
            $zipSize = (Get-Item dist/coze_plugin.zip).Length / 1KB
            Write-Host "âœ… coze_plugin.zip å·²ç”Ÿæˆ: $([math]::Round($zipSize, 2)) KB"
          } else {
            Write-Host "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° coze_plugin.zip"
          }

          echo "version=$latestTag" >> $env:GITHUB_OUTPUT
