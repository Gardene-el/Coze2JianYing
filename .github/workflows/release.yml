name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿åˆ†æ commits
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Set up UTF-8 encoding
        run: |
          # è®¾ç½® Python ä½¿ç”¨ UTF-8 ç¼–ç 
          [System.Environment]::SetEnvironmentVariable('PYTHONIOENCODING', 'utf-8', 'Process')
          [System.Environment]::SetEnvironmentVariable('PYTHONUTF8', '1', 'Process')

          # è®¾ç½® Git ä½¿ç”¨ UTF-8
          git config --global core.quotepath false
          git config --global i18n.commitencoding utf-8
          git config --global i18n.logoutputencoding utf-8

          # éªŒè¯è®¾ç½®
          Write-Host "PYTHONIOENCODING: $env:PYTHONIOENCODING"
          Write-Host "Git encoding config:"
          git config --get i18n.commitencoding
          git config --get i18n.logoutputencoding

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-semantic-release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ç¡®ä¿ UTF-8 ç¼–ç 
          git config core.quotepath false
          git config i18n.commitencoding utf-8
          git config i18n.logoutputencoding utf-8

      - name: Check for version bump
        id: check_version
        run: |
          semantic-release version --print --no-commit --no-tag --no-push > version_output.txt 2>&1 || true
          $output = Get-Content version_output.txt -Raw
          Write-Host "Semantic Release Output:"
          Write-Host $output

          if ($output -match "No release will be made") {
            Write-Host "::notice::æ²¡æœ‰éœ€è¦å‘å¸ƒçš„æ›´æ–°ï¼ˆæ— ç¬¦åˆæ¡ä»¶çš„ commitï¼‰"
            echo "should_release=false" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "::notice::æ£€æµ‹åˆ°éœ€è¦å‘å¸ƒçš„æ›´æ–°"
            echo "should_release=true" >> $env:GITHUB_OUTPUT
          }

      - name: Build executable
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          python build.py

      - name: Semantic Release
        if: steps.check_version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          # è®¾ç½®ç¼–ç ç¯å¢ƒå˜é‡
          $env:PYTHONIOENCODING = 'utf-8'
          $env:PYTHONUTF8 = '1'

          # æ‰§è¡Œ semantic-release
          semantic-release version
          semantic-release publish

      - name: Get new version
        if: steps.check_version.outputs.should_release == 'true'
        id: version
        run: |
          $version = semantic-release version --print
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "æ–°ç‰ˆæœ¬: $version"

      - name: Upload release asset
        if: steps.check_version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.version.outputs.version }}"
          if (Test-Path dist/CozeJianYingDraftGenerator.exe) {
            gh release upload $version dist/CozeJianYingDraftGenerator.exe --clobber
            Write-Host "âœ… å·²ä¸Šä¼  CozeJianYingDraftGenerator.exe åˆ° Release $version"
          } else {
            Write-Host "âŒ æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          }

      - name: Summary
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          Write-Host "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
          Write-Host "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          Write-Host "æŸ¥çœ‹ Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
