name: CI Build Test

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop]
    # main 分支的 push 交给 release.yml 处理

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Set up UTF-8 encoding
        run: |
          # 设置 Python 使用 UTF-8 编码
          [System.Environment]::SetEnvironmentVariable('PYTHONIOENCODING', 'utf-8', 'Process')
          [System.Environment]::SetEnvironmentVariable('PYTHONUTF8', '1', 'Process')

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1
        run: |
          python build.py

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: CozeJianYingDraftGenerator-Windows-${{ github.sha }}
          path: dist/CozeJianYingDraftGenerator.exe
          retention-days: 7

      - name: Test executable exists
        run: |
          if (Test-Path dist/CozeJianYingDraftGenerator.exe) {
            Write-Host "✅ 构建成功！可执行文件已生成"
            $fileSize = (Get-Item dist/CozeJianYingDraftGenerator.exe).Length / 1MB
            Write-Host "文件大小: $([math]::Round($fileSize, 2)) MB"
          } else {
            Write-Host "❌ 构建失败！找不到可执行文件"
            exit 1
          }
